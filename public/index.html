<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP8266 Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background-color: #333;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #deviceSelect {
      padding: 5px;
      font-size: 1rem;
    }

    main {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 10px;
      background: #f4f4f4;
    }

    .chart-container {
      width: 95%;
      height: 250px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <header>
    <h2>ESP8266 Sensor Dashboard</h2>
    <select id="deviceSelect"></select>
  </header>

  <main>
    <div class="chart-container">
      <h3>DHT Temperature (&deg;C)</h3>
      <canvas id="dhtTempChart"></canvas>
    </div>

    <div class="chart-container">
      <h3>DHT Humidity (%)</h3>
      <canvas id="dhtHumChart"></canvas>
    </div>

    <div class="chart-container">
      <h3>BMP Temperature (&deg;C)</h3>
      <canvas id="bmpTempChart"></canvas>
    </div>

    <div class="chart-container">
      <h3>BMP Pressure (hPa)</h3>
      <canvas id="bmpPressChart"></canvas>
    </div>

    <div class="chart-container">
      <h3>BMP Altitude (m)</h3>
      <canvas id="bmpAltChart"></canvas>
    </div>
  </main>

  <script>
    // Initialize charts
    const createChart = (ctxId, label, color, yLabel) => {
      return new Chart(document.getElementById(ctxId).getContext('2d'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label,
            borderColor: color,
            data: [],
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Time' }},
            y: { title: { display: true, text: yLabel }}
          }
        }
      });
    };

    const dhtTempChart = createChart('dhtTempChart', 'DHT Temp (째C)', 'red', '째C');
    const dhtHumChart = createChart('dhtHumChart', 'DHT Humidity (%)', 'blue', '%');
    const bmpTempChart = createChart('bmpTempChart', 'BMP Temp (째C)', 'orange', '째C');
    const bmpPressChart = createChart('bmpPressChart', 'BMP Pressure (hPa)', 'green', 'hPa');
    const bmpAltChart = createChart('bmpAltChart', 'BMP Altitude (m)', 'purple', 'm');

    // Fetch device list and populate dropdown
    async function loadDevices() {
      try {
        const res = await fetch('/devices');
        const devices = await res.json();

        const select = document.getElementById('deviceSelect');
        select.innerHTML = '';

        devices.forEach(deviceId => {
          const option = document.createElement('option');
          option.value = deviceId;
          option.textContent = deviceId;
          select.appendChild(option);
        });

        if (devices.length > 0) {
          loadHistory(devices[0]);
        }
      } catch (err) {
        console.error('Error loading devices:', err);
      }
    }

    // Load historical data for selected device
    async function loadHistory(deviceId) {
      try {
        const res = await fetch(`/history/${deviceId}`);
        const history = await res.json();

        if (!Array.isArray(history)) {
          console.error('History data is not an array:', history);
          return;
        }

        // Clear all charts
        [dhtTempChart, dhtHumChart, bmpTempChart, bmpPressChart, bmpAltChart].forEach(chart => {
          chart.data.labels = [];
          chart.data.datasets[0].data = [];
        });

        // Populate charts with historical data
        history.forEach(entry => {
          const timeLabel = new Date(entry.timestamp).toLocaleTimeString();

          dhtTempChart.data.labels.push(timeLabel);
          dhtTempChart.data.datasets[0].data.push(entry.dht_temperature);

          dhtHumChart.data.labels.push(timeLabel);
          dhtHumChart.data.datasets[0].data.push(entry.dht_humidity);

          bmpTempChart.data.labels.push(timeLabel);
          bmpTempChart.data.datasets[0].data.push(entry.bmp_temperature);

          bmpPressChart.data.labels.push(timeLabel);
          bmpPressChart.data.datasets[0].data.push(entry.bmp_pressure_hPa);

          bmpAltChart.data.labels.push(timeLabel);
          bmpAltChart.data.datasets[0].data.push(entry.bmp_altitude);
        });

        // Update all charts
        [dhtTempChart, dhtHumChart, bmpTempChart, bmpPressChart, bmpAltChart].forEach(chart => chart.update());

      } catch (err) {
        console.error('Error fetching history:', err);
      }
    }

    // Device change listener
    document.getElementById('deviceSelect').addEventListener('change', e => {
      loadHistory(e.target.value);
    });

    // Periodic refresh (every 60s)
    setInterval(() => {
      const currentDevice = document.getElementById('deviceSelect').value;
      if (currentDevice) loadHistory(currentDevice);
    }, 60000);

    // Initial load
    loadDevices();
  </script>
</body>
</html>
